<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<title>Masacre Masacradora</title>
	<th:block th:fragment="header">
		<meta charset="utf-8">
		<link rel="stylesheet" th:href="@{/css/main.css}" href="css/main.css" type="text/css" />
		<script th:src="@{/js/kclient.js}" type="text/javascript"></script>
		<script>
			const config = {
				socketUrl: '[[${session.ws}?:false]]',
				csrf: {
					name: "[[${_csrf.parameterName}]]",
					value: "[[${_csrf.token}]]"
				},
				admin: [[${ session.user != null && session.user.hasRole('admin') } ? 'true' : 'false']],
				userId: [[${ session.user != null } ? ${ session.user.id }: -1]]
			};

			/**
						 * WebSocket API, which only works once initialized
						 */
			const ws = {

				/**
				 * WebSocket, or null if none connected
				 */
				socket: null,

				/**
				 * Sends a string to the server via the websocket.
				 * @param {string} text to send 
				 * @returns nothing
				 */
				send: (text) => {
					if (ws.socket != null) {
						ws.socket.send(text);
					}
				},

				/**
				 * Default action when text is received. 
				 * @returns
				 */
				receive: (text) => {
					console.log(text);
					obj = JSON.parse(text);
					handleMessage(obj);
				},

				/**
				 * Attempts to establish communication with the specified
				 * web-socket endpoint. If successfull, will call 
				 * @returns
				 */
				initialize: (endpoint) => {
					try {
						ws.socket = new WebSocket(endpoint);
						ws.socket.onmessage = (e) => ws.receive(e.data);
						console.log("Connected to WS '" + endpoint + "'")
					} catch (e) {
						console.log("Error, connection to WS '" + endpoint + "' FAILED: ", e);
					}
				}
			}

			/**
			 * Actions to perform once the page is fully loaded
			 */
			window.addEventListener('load', () => {
				if (config.socketUrl !== false) {
					ws.initialize(config.socketUrl);
				}

			});

		</script>
	</th:block>
</head>

<body>
	Head fragment - rest intentionally left empty.
</body>

</html>